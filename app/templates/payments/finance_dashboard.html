{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold"><i class="bi bi-cash-coin"></i> Finance Dashboard</h2>
                    <p class="text-muted mb-0">Sales analytics and revenue tracking</p>
                </div>
                <div>
                    <form method="GET" class="d-flex gap-2">
                        <select name="month" class="form-select" onchange="this.form.submit()">
                            {% for i in range(1, 13) %}
                                <option value="{{ i }}" {% if i == selected_month %}selected{% endif %}>
                                    {{ ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                                        'July', 'August', 'September', 'October', 'November', 'December'][i] }}
                                </option>
                            {% endfor %}
                        </select>
                        <select name="year" class="form-select" onchange="this.form.submit()">
                            {% for y in range(2024, 2028) %}
                                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #e63946 0%, #ff5a5f 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">This Month</h6>
                            <h3 class="mb-0 fw-bold">${{ "{:,.2f}".format(current_month_total['total']) }}</h3>
                            <small class="opacity-75">{{ current_month_total['count'] }} transactions</small>
                        </div>
                        <i class="bi bi-calendar-month" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #00cc66 0%, #00e673 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">This Quarter</h6>
                            <h3 class="mb-0 fw-bold">${{ "{:,.2f}".format(quarterly_sales[(selected_month-1)//3]['total']) }}</h3>
                            <small class="opacity-75">Q{{ (selected_month-1)//3 + 1 }} {{ selected_year }}</small>
                        </div>
                        <i class="bi bi-graph-up-arrow" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #0066cc 0%, #0080ff 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Year Total</h6>
                            <h3 class="mb-0 fw-bold">${{ "{:,.2f}".format(year_total) }}</h3>
                            <small class="opacity-75">{{ year_count }} transactions</small>
                        </div>
                        <i class="bi bi-trophy" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #ffc107 0%, #ffcd38 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 opacity-75">Avg Per Sale</h6>
                            <h3 class="mb-0 fw-bold">
                                ${{ "{:,.2f}".format(year_total / year_count if year_count > 0 else 0) }}
                            </h3>
                            <small class="opacity-75">Average transaction</small>
                        </div>
                        <i class="bi bi-calculator" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar and Sales Details -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #0066cc; color: white;">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> {{ month_name }} {{ selected_year }} - Daily Sales</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0" style="font-size: 0.9rem;">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">Sun</th>
                                    <th class="text-center">Mon</th>
                                    <th class="text-center">Tue</th>
                                    <th class="text-center">Wed</th>
                                    <th class="text-center">Thu</th>
                                    <th class="text-center">Fri</th>
                                    <th class="text-center">Sat</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week in calendar_data %}
                                    <tr>
                                        {% for day in week %}
                                            <td class="p-2 calendar-day {% if day == 0 %}empty-day{% elif day in daily_sales %}has-sales{% endif %}"
                                                style="height: 100px; vertical-align: top; position: relative; cursor: pointer;"
                                                {% if day > 0 and day in daily_sales %}
                                                    onclick="showDayDetails({{ selected_year }}, {{ selected_month }}, {{ day }})"
                                                {% endif %}>
                                                {% if day > 0 %}
                                                    <div class="day-number fw-bold mb-1" style="font-size: 1.1rem;">{{ day }}</div>
                                                    {% if day in daily_sales %}
                                                        <div class="sales-badge" style="background-color: #00cc66; color: white; border-radius: 15px; padding: 2px 8px; font-size: 0.75rem; margin-bottom: 3px;">
                                                            ${{ "{:,.0f}".format(daily_sales[day]['total']) }}
                                                        </div>
                                                        <div class="text-muted" style="font-size: 0.7rem;">
                                                            <i class="bi bi-receipt"></i> {{ daily_sales[day]['count'] }} sales
                                                        </div>
                                                    {% else %}
                                                        <div class="text-muted" style="font-size: 0.7rem;">No sales</div>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Monthly Breakdown -->
            <div class="card shadow-sm mb-3">
                <div class="card-header" style="background-color: #e63946; color: white;">
                    <h6 class="mb-0"><i class="bi bi-bar-chart-line"></i> Monthly Breakdown {{ selected_year }}</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% for i in range(1, 13) %}
                        {% set month_data = monthly_data.get(i, {'total': 0, 'count': 0}) %}
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 {% if i < 12 %}border-bottom{% endif %}">
                            <div>
                                <strong>{{ ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][i] }}</strong>
                                <br>
                                <small class="text-muted">{{ month_data['count'] }} sales</small>
                            </div>
                            <div class="text-end">
                                <span class="badge" style="background-color: {% if month_data['total'] > 0 %}#00cc66{% else %}#6c757d{% endif %}; font-size: 0.9rem;">
                                    ${{ "{:,.0f}".format(month_data['total']) }}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quarterly Summary -->
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #ffc107; color: white;">
                    <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Quarterly Summary</h6>
                </div>
                <div class="card-body">
                    {% for quarter in quarterly_sales %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>Q{{ quarter['quarter'] }} {{ selected_year }}</strong>
                                <span class="badge bg-primary">${{ "{:,.0f}".format(quarter['total']) }}</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" 
                                     style="width: {{ (quarter['total'] / year_total * 100) if year_total > 0 else 0 }}%; background-color: #0066cc;"
                                     role="progressbar">
                                    {{ "{:.0f}".format((quarter['total'] / year_total * 100) if year_total > 0 else 0) }}%
                                </div>
                            </div>
                            <small class="text-muted">{{ quarter['count'] }} transactions</small>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions and Top Performers -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #00cc66; color: white;">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent Transactions</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Bootcamp</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                    <tr>
                                        <td>{{ payment.paid_at.strftime('%b %d, %Y') }}</td>
                                        <td>{{ payment.enrollment.student.full_name }}</td>
                                        <td>{{ payment.enrollment.batch.bootcamp.name }}</td>
                                        <td><strong style="color: #00cc66;">${{ "{:,.2f}".format(payment.amount) }}</strong></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm mb-3">
                <div class="card-header" style="background-color: #0066cc; color: white;">
                    <h6 class="mb-0"><i class="bi bi-trophy-fill"></i> Top Students by Revenue</h6>
                </div>
                <div class="card-body">
                    {% for student in top_students %}
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div>
                                <strong>{{ student.full_name }}</strong><br>
                                <small class="text-muted">{{ student.payment_count }} payments</small>
                            </div>
                            <span class="badge bg-success" style="font-size: 0.9rem;">
                                ${{ "{:,.2f}".format(student.total_paid) }}
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #e63946; color: white;">
                    <h6 class="mb-0"><i class="bi bi-star-fill"></i> Top Bootcamps by Revenue</h6>
                </div>
                <div class="card-body">
                    {% for bootcamp in top_bootcamps %}
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div>
                                <strong>{{ bootcamp.name }}</strong><br>
                                <small class="text-muted">{{ bootcamp.enrollments }} enrollments</small>
                            </div>
                            <span class="badge bg-danger" style="font-size: 0.9rem;">
                                ${{ "{:,.2f}".format(bootcamp.total_revenue) }}
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #0066cc; color: white;">
                <h5 class="modal-title"><i class="bi bi-calendar-day"></i> Daily Sales Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dayDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-day {
    transition: all 0.3s ease;
}

.calendar-day.has-sales:hover {
    background-color: #f8f9fa;
    transform: scale(1.02);
}

.empty-day {
    background-color: #f8f9fa;
}

.day-number {
    color: #333;
}

.calendar-day.has-sales {
    border-left: 3px solid #00cc66;
}
</style>

<script>
function showDayDetails(year, month, day) {
    const modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
    modal.show();
    
    fetch(`/payments/finance/api/sales/${year}/${month}/${day}`)
        .then(response => response.json())
        .then(data => {
            let html = `
                <div class="mb-3">
                    <h4>${data.date}</h4>
                    <div class="row">
                        <div class="col-6">
                            <div class="card" style="background-color: #e7f5e7;">
                                <div class="card-body">
                                    <h5 class="mb-0" style="color: #00cc66;">$${data.total.toFixed(2)}</h5>
                                    <small class="text-muted">Total Sales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card" style="background-color: #e7f0ff;">
                                <div class="card-body">
                                    <h5 class="mb-0" style="color: #0066cc;">${data.count}</h5>
                                    <small class="text-muted">Transactions</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>Student</th>
                                <th>Bootcamp</th>
                                <th>Amount</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.transactions.forEach(txn => {
                html += `
                    <tr>
                        <td>${txn.time}</td>
                        <td>${txn.student}</td>
                        <td><small>${txn.bootcamp} - ${txn.batch}</small></td>
                        <td><strong style="color: #00cc66;">$${txn.amount.toFixed(2)}</strong></td>
                        <td><span class="badge bg-secondary">${txn.method}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('dayDetailsContent').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('dayDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error loading sales details
                </div>
            `;
        });
}
</script>
{% endblock %}
