// This is your Prisma schema file
// Production-grade Bootcamp Management System Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// AUTHENTICATION & USER MANAGEMENT
// ==========================================

enum UserRole {
  ADMIN
  SALES
  INSTRUCTOR
  MENTOR
  STUDENT
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole
  fullName      String   @map("full_name")
  phone         String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens       RefreshToken[]
  leadsCreated        Lead[]              @relation("LeadCreatedBy")
  leadsAssigned       Lead[]              @relation("LeadAssignedTo")
  leadLogs            LeadLog[]
  bootcampsCreated    Bootcamp[]
  enrollments         Enrollment[]
  instructorBatches   InstructorBatch[]
  mentorBatches       MentorBatch[]
  submissions         Submission[]
  gradesGiven         Grade[]
  announcementsCreated Announcement[]
  notifications       Notification[]
  certificatesIssued  Certificate[]       @relation("CertificateIssuedBy")

  @@map("users")
  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
}

// ==========================================
// CRM & LEAD MANAGEMENT
// ==========================================

enum LeadStatus {
  NEW
  CONTACTED
  FOLLOWUP
  INTERESTED
  ENROLLED
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  ADVERTISEMENT
  DIRECT
  OTHER
}

model Lead {
  id          String     @id @default(uuid())
  fullName    String     @map("full_name")
  email       String
  phone       String?
  source      LeadSource
  status      LeadStatus @default(NEW)
  assignedTo  String?    @map("assigned_to")
  createdBy   String     @map("created_by")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  assignedToUser User?     @relation("LeadAssignedTo", fields: [assignedTo], references: [id])
  createdByUser  User      @relation("LeadCreatedBy", fields: [createdBy], references: [id])
  logs           LeadLog[]

  @@map("leads")
  @@index([email])
  @@index([status])
  @@index([assignedTo])
}

model LeadLog {
  id             String    @id @default(uuid())
  leadId         String    @map("lead_id")
  note           String    @db.Text
  nextFollowUp   DateTime? @map("next_follow_up")
  createdBy      String    @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at")

  lead          Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdByUser User @relation(fields: [createdBy], references: [id])

  @@map("lead_logs")
  @@index([leadId])
  @@index([nextFollowUp])
}

// ==========================================
// BOOTCAMP & BATCH MANAGEMENT
// ==========================================

enum BootcampMode {
  LIVE
  RECORDED
  HYBRID
}

model Bootcamp {
  id          String       @id @default(uuid())
  title       String
  description String       @db.Text
  mode        BootcampMode
  price       Decimal      @db.Decimal(10, 2)
  duration    Int?         // in weeks
  isActive    Boolean      @default(true) @map("is_active")
  createdBy   String       @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  createdByUser User      @relation(fields: [createdBy], references: [id])
  batches       Batch[]
  modules       Module[]

  @@map("bootcamps")
  @@index([isActive])
}

enum BatchStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

model Batch {
  id         String      @id @default(uuid())
  bootcampId String      @map("bootcamp_id")
  batchName  String      @map("batch_name")
  startDate  DateTime    @map("start_date")
  endDate    DateTime    @map("end_date")
  capacity   Int
  status     BatchStatus @default(UPCOMING)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  // Relations
  bootcamp        Bootcamp          @relation(fields: [bootcampId], references: [id], onDelete: Cascade)
  enrollments     Enrollment[]
  instructors     InstructorBatch[]
  mentors         MentorBatch[]
  announcements   Announcement[]
  attendanceLogs  Attendance[]

  @@map("batches")
  @@index([bootcampId])
  @@index([status])
  @@index([startDate])
}

model InstructorBatch {
  id           String   @id @default(uuid())
  batchId      String   @map("batch_id")
  instructorId String   @map("instructor_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  batch      Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  instructor User  @relation(fields: [instructorId], references: [id])

  @@unique([batchId, instructorId])
  @@map("instructor_batches")
  @@index([batchId])
  @@index([instructorId])
}

model MentorBatch {
  id         String   @id @default(uuid())
  batchId    String   @map("batch_id")
  mentorId   String   @map("mentor_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  batch  Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  mentor User  @relation(fields: [mentorId], references: [id])

  @@unique([batchId, mentorId])
  @@map("mentor_batches")
  @@index([batchId])
  @@index([mentorId])
}

// ==========================================
// ENROLLMENT & PAYMENTS
// ==========================================

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
}

model Enrollment {
  id         String           @id @default(uuid())
  studentId  String           @map("student_id")
  batchId    String           @map("batch_id")
  status     EnrollmentStatus @default(PENDING)
  enrolledAt DateTime         @default(now()) @map("enrolled_at")
  completedAt DateTime?       @map("completed_at")
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  // Relations
  student      User          @relation(fields: [studentId], references: [id])
  batch        Batch         @relation(fields: [batchId], references: [id])
  payments     Payment[]
  attendances  Attendance[]
  certificate  Certificate?

  @@unique([studentId, batchId])
  @@map("enrollments")
  @@index([studentId])
  @@index([batchId])
  @@index([status])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  UPI
  NET_BANKING
  CASH
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id            String        @id @default(uuid())
  enrollmentId  String        @map("enrollment_id")
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique @map("transaction_id")
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map("payments")
  @@index([enrollmentId])
  @@index([status])
}

// ==========================================
// LMS - LEARNING MANAGEMENT
// ==========================================

model Module {
  id          String   @id @default(uuid())
  bootcampId  String   @map("bootcamp_id")
  title       String
  description String?  @db.Text
  orderIndex  Int      @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  bootcamp Bootcamp @relation(fields: [bootcampId], references: [id], onDelete: Cascade)
  lessons  Lesson[]

  @@map("modules")
  @@index([bootcampId])
  @@index([orderIndex])
}

enum ContentType {
  VIDEO
  DOCUMENT
  LINK
  QUIZ
  TEXT
}

model Lesson {
  id          String      @id @default(uuid())
  moduleId    String      @map("module_id")
  title       String
  description String?     @db.Text
  contentType ContentType @map("content_type")
  contentUrl  String?     @map("content_url") @db.Text
  duration    Int?        // in minutes
  orderIndex  Int         @map("order_index")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  module      Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  resources   Resource[]
  assignments Assignment[]

  @@map("lessons")
  @@index([moduleId])
  @@index([orderIndex])
}

enum ResourceType {
  PDF
  VIDEO
  LINK
  CODE
  IMAGE
  OTHER
}

model Resource {
  id        String       @id @default(uuid())
  lessonId  String       @map("lesson_id")
  title     String
  type      ResourceType
  url       String       @db.Text
  createdAt DateTime     @default(now()) @map("created_at")

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("resources")
  @@index([lessonId])
}

model Attendance {
  id           String   @id @default(uuid())
  enrollmentId String   @map("enrollment_id")
  batchId      String   @map("batch_id")
  sessionDate  DateTime @map("session_date")
  present      Boolean  @default(false)
  markedAt     DateTime @default(now()) @map("marked_at")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  batch      Batch      @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, sessionDate])
  @@map("attendance")
  @@index([enrollmentId])
  @@index([sessionDate])
}

// ==========================================
// ASSIGNMENTS & GRADING
// ==========================================

model Assignment {
  id          String    @id @default(uuid())
  lessonId    String    @map("lesson_id")
  title       String
  description String    @db.Text
  maxScore    Int       @default(100) @map("max_score")
  deadline    DateTime?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  lesson      Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@map("assignments")
  @@index([lessonId])
  @@index([deadline])
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
  LATE
}

model Submission {
  id            String           @id @default(uuid())
  assignmentId  String           @map("assignment_id")
  studentId     String           @map("student_id")
  submissionUrl String?          @map("submission_url") @db.Text
  content       String?          @db.Text
  status        SubmissionStatus @default(PENDING)
  submittedAt   DateTime?        @map("submitted_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User       @relation(fields: [studentId], references: [id])
  grade      Grade?

  @@unique([assignmentId, studentId])
  @@map("submissions")
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

model Grade {
  id           String    @id @default(uuid())
  submissionId String    @unique @map("submission_id")
  score        Int
  feedback     String?   @db.Text
  gradedBy     String    @map("graded_by")
  gradedAt     DateTime  @default(now()) @map("graded_at")

  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  gradedByUser User       @relation(fields: [gradedBy], references: [id])

  @@map("grades")
  @@index([submissionId])
}

// ==========================================
// COMMUNICATION
// ==========================================

model Announcement {
  id        String   @id @default(uuid())
  batchId   String   @map("batch_id")
  title     String
  message   String   @db.Text
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  batch         Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  createdByUser User  @relation(fields: [createdBy], references: [id])

  @@map("announcements")
  @@index([batchId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ==========================================
// CERTIFICATES
// ==========================================

model Certificate {
  id               String   @id @default(uuid())
  enrollmentId     String   @unique @map("enrollment_id")
  verificationCode String   @unique @map("verification_code")
  issuedBy         String   @map("issued_by")
  issuedAt         DateTime @default(now()) @map("issued_at")

  enrollment     Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  issuedByUser   User       @relation("CertificateIssuedBy", fields: [issuedBy], references: [id])

  @@map("certificates")
  @@index([verificationCode])
}
